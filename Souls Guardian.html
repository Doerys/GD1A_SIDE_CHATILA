<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" /><title>Souls Guardian</title>

        <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
        <link href="styles.css" media="all" rel="stylesheet" type="text/css" />

        <style type="text/css"> body { margin: 0; }</style>
    </head>
    <body>
        <script type="text/javascript">
            
            var config = {
                type: Phaser.AUTO,

                // Dimensions du jeu (50 x 50 cases de 32 pixels)
                width: 1200, height: 750,
                
                // Physique du jeu (gravité)
                physics: {
                    default: 'arcade',
                    arcade: {
                    gravity: { y: 600 },
                    debug: false
                    }},

                scene: {preload: preload, create: create, update: update }
                };

                new Phaser.Game(config);

                function preload(){
                    
                    // chargement tuiles de jeu
                    this.load.image("Phaser_tuilesdejeu", "assets/tuilesJeu.png");

                    // chargement de la carte
                    this.load.tilemapTiledJSON("carte", "assets/map.json");
                    this.load.image('background', 'assets/background.png');
                    this.load.image('secondPlan', 'assets/secondPlan.png'); 
                    this.load.spritesheet('perso','assets/perso.png',
                        { frameWidth: 32, frameHeight: 48 });
                }

                // annonce des variables
                var platforms;
                var player;
                var cursors;
                var scoreText;
                var gameOver = false;

                function create(){

                    // ajout des images de background
                    this.add.image(800, 800, 'background');
                    this.add.image(800, 800, 'secondPlan');

                    // chargement de la carte
                    const carteDuNiveau = this.add.tilemap("carte");

                    // chargement du jeu de tuiles
                    const tileset = carteDuNiveau.addTilesetImage(
                            "PremierPlan",
                            "Phaser_tuilesdejeu",
                            );

                    // chargement du calque calque_plateformes
                    const plateformes = carteDuNiveau.createLayer(
                            "plateformes",
                            tileset
                            );

                    // chargement du calque pickupobjects
                    const pickupobjects = carteDuNiveau.createLayer(
                            "pickupobjects",
                            tileset
                            );

                    // chargement du calque obstacles
                    const obstacles = carteDuNiveau.createLayer(
                            "obstacles",
                            tileset
                            );

                    // définition des tuiles de plateformes qui sont solides
                    // utilisation de la propriété estSolide
                    plateformes.setCollisionByProperty({ estSolide: true });

                    // on génère le sprite du personnage à partir de la sprite sheet
                    player = this.physics.add.sprite(1350, 680, 'perso');
                    
                    //Ajoute un rebond du joueur lors du contact au sol
                    player.setBounce(0);

                    //Collision entre le joueur et les confins du monde
                    player.setCollideWorldBounds(true);

                    //Collision entre le joueur et les plateformes
                    this.physics.add.collider(player, plateformes); 
                    
                    //Animations gauche, face à la caméra et droite
                    this.anims.create({
                        key: 'left',
                        frames: this.anims.generateFrameNumbers('perso', {start:0,end:3}),
                        frameRate: 10,
                        repeat: -1
                    });

                    this.anims.create({
                        key: 'turn',
                        frames: [ { key: 'perso', frame: 4 } ],
                        frameRate: 20
                    });

                    this.anims.create({
                        key: 'right',
                        frames: this.anims.generateFrameNumbers('perso', {start:5,end:8}),
                        frameRate: 10,
                        repeat: -1
                    });           
                    
                    cursors = this.input.keyboard.createCursorKeys();

                    spaceBar = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);

                    // redimentionnement du monde avec les dimensions calculées via tiled
                    this.physics.world.setBounds(0, 0, 1600, 1600);
                    
                    //  ajout du champs de la caméra de taille identique à celle du monde
                    this.cameras.main.setBounds(0, 0, 1600, 1600);
                    
                    this.cameras.main.setSize(1200, 750);

                    this.cameras.main.setZoom(2.5, 2.5)

                    // ancrage de la caméra sur le joueur
                    this.cameras.main.startFollow(player); 

                    //affiche un texte à l’écran, pour le score
                    scoreText=this.add.text(16,16,'score: 0',{fontSize:'32px',fill:'#000'});
                }

                //Fonction exécuter à chaque frame du jeu
                function update(){

                    if (cursors.left.isDown){ //si la touche gauche est appuyée
                        player.setVelocityX(-150); //alors vitesse négative en X
                        player.anims.play('left', true); //et animation => gauche
                        }
                        else if (cursors.right.isDown){ //sinon si la touche droite est appuyée
                        player.setVelocityX(150); //alors vitesse positive en X
                        player.anims.play('right', true); //et animation => droite
                        }
                        else{ // sinon
                        player.setVelocityX(0); //vitesse nulle
                        player.anims.play('turn'); //animation fait face caméra
                        }
                        if ((cursors.up.isDown || spaceBar.isDown) && player.body.blocked.down){
                        //si touche haut appuyée ET que le perso touche le sol
                        player.setVelocityY(-300); //alors vitesse verticale négative
                        //(on saute)
                        }

                    if (gameOver){return;}
                }
        </script>
    </body>
</html>
