<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" /><title>Souls Guardian</title>

        <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
        <link href="styles.css" media="all" rel="stylesheet" type="text/css" />

        <style type="text/css"> body { margin: 0; }</style>>
    </head>
    <body>
        <script type="text/javascript">
            
            var config = {
                type: Phaser.AUTO,

                // Dimensions du jeu (50 x 50 cases de 32 pixels)
                width: 1200, height: 750,
                
                // Physique du jeu (gravité)
                physics: {
                    default: 'arcade',
                    arcade: {
                    gravity: { y: 300 },
                    debug: true
                    }},

                scene: {preload: preload, create: create, update: update }
                };

                new Phaser.Game(config);

                // VARIABLES - annonce des variables
                let platforms;
                let player;
                let espritsLayer;
                
                let cursors;
                
                let health = 4;


                let gameOver = false;
                let commandesLocked = false;
                let wallJumpLocked = false;
                
                let esprits;
                let textScore;
                let espritScore = 0;

                let speedMoveX = 150;
                let speedMoveY = 210;
                let playerInertie = 0;

                let wallIce = false;

                // FONCTION PRELOAD - précharger en mémoire les éléments de notre jeu (assets)

                function preload(){

                    // Préchargement de l'UI
                    this.load.image('lifeFull',"assets/Life_Full.png");
                    this.load.image('life1',"assets/Life_Hurt_1.png");
                    this.load.image('life2',"assets/Life_Hurt_2.png");
                    this.load.image('life3',"assets/Life_Hurt_3.png");
                    this.load.image('lifeDead',"assets/Life_Dead.png");

                    this.load.image('fond_score', 'assets/fond_chiffre.png');

                    this.load.image('espritUI', "assets/esprit.png");
                    this.load.image('espritCollectible', 'assets/esprit_in_game.png');
                    
                    // NIVEAU - Préchargement de la carte

                        // NIVEAU - chargement tuiles de jeu
                        this.load.image("Phaser_tuilesdejeu", "assets/tuilesJeu.png");

                        // NIVEAU - chargement de la carte
                        this.load.tilemapTiledJSON("carte", "assets/map.json");
                        this.load.image('background', 'assets/background.png');
                        this.load.image('secondPlan', 'assets/secondPlan.png'); 
                        this.load.spritesheet('perso','assets/perso.png',
                            { frameWidth: 32, frameHeight: 48 });
                    }

                    // Préchargement apparence monstre
                    this.load.image('monsterRightApparence', 'assets/monstre_right.png');
                    this.load.image('monsterLeftApparence', 'assets/monstre_left.png');

                    this.load.image('BordureEnnemi', 'assets/perso2.png');

                // FONCTION CREATE - Gère le stade initial du jeu

                function create(){

                    // NIVEAU

                        // NIVEAU - ajout des images de background

                        this.backgroundParallax = this.add.tileSprite(0, 0, 1600, 1600, "background");
                        this.backgroundParallax.setOrigin(0, 0);
                        this.backgroundParallax.setScrollFactor(0.5, 1);

                        this.sndPlanParallax = this.add.tileSprite(0, 0, 1600, 1600, "secondPlan");
                        this.sndPlanParallax.setOrigin(0, 0);
                        this.sndPlanParallax.setScrollFactor(0.9, 1);

                        /*this.add.image(800, 800, 'background')/*.setScrollFactorX(0.05)*/;
                        /*this.add.image(800, 800, 'secondPlan')/*.setScrollFactorX(0.3)*/;

                        // NIVEAU - Intégration de la map de TILED
                            // chargement de la carte
                            const carteDuNiveau = this.add.tilemap("carte");

                            // chargement du jeu de tuiles
                            const tileset = carteDuNiveau.addTilesetImage(
                                    "tuiles_de_jeu",
                                    "Phaser_tuilesdejeu",
                                    );

                            // chargement du calque calque_plateformes
                            const plateformes = carteDuNiveau.createLayer(
                                    "plateformes",
                                    tileset
                                    );

                            // chargement calque neige

                            const plateformesNeige = carteDuNiveau.createLayer(
                                    "plateformesNeige",
                                    tileset
                                    );

                            // chargement calque glace

                            const plateformesGlace = carteDuNiveau.createLayer(
                                    "plateformesGlace",
                                    tileset
                                    );

                            // chargement du calque obstacles
                            const obstacles = carteDuNiveau.createLayer(
                                    "obstacles",
                                    tileset
                                    );

                            esprits = this.physics.add.staticGroup();
                            espritsLayer = carteDuNiveau.getObjectLayer('espritsLayer')['objects'];

                        // NIVEAU - Plateformes solides
                        plateformes.setCollisionByProperty({estSolide: true });

                        plateformesNeige.setCollisionByProperty({estNeige : true });

                        plateformesGlace.setCollisionByProperty({estGlace : true });

                        /*neigeRalentit = this.physics.add.group();
                        calque_ObjetRalentisseur = carteDuNiveau.getObjectLayer('ObjetRalentisseur');
                        calque_ObjetRalentisseur.objects.forEach( calque_ObjetRalentisseur => {
                        const PORalentisseur = neigeRalentit.create( calque_ObjetRalentisseur.x + 16, calque_ObjetRalentisseur.y + 15, "TextureRalentisseur").body.setAllowGravity(false).setImmovable(true);*/

                        // NIVEAU - Obstacles mortels
                        obstacles.setCollisionByProperty({ estMortel : true});
                        
                        // NIVEAU - limites du monde avec les dimensions calculées via tiled
                        this.physics.world.setBounds(0, 0, 1600, 1600);

                    //COLLECTIBLES

                        espritsLayer.forEach(object => {
                        let obj = esprits.create(object.x + 16, object.y -16, 'espritCollectible');
                            obj.setScale(object.width/32, object.height/32);
                            obj.body.width = object.width;
                            obj.body.height = object.height;
                        });

                    //Création monstre droite
                    
                    monstresRight = this.physics.add.group();
                    monstresRightLayer = carteDuNiveau.getObjectLayer('monsterRightApparence');
                    monstresRightLayer.objects.forEach( monstresRightLayer => {
                        const MmonstresRightLayer = monstresRight.create( monstresRightLayer.x + 16, monstresRightLayer.y + 16, "monsterRightApparence").body.setAllowGravity(false).setBounce(1);
                    });
                    monstresRight.setVelocity(0, 150);

                    //Création monstre gauche

                    monstresLeft = this.physics.add.group();
                    monstresLeftLayer = carteDuNiveau.getObjectLayer('monsterLeftApparence');
                    monstresLeftLayer.objects.forEach( monstresLeftLayer => {
                        const MMonstresLeftLayer = monstresLeft.create( monstresLeftLayer.x + 16, monstresLeftLayer.y + 16, "monsterLeftApparence").body.setAllowGravity(false).setBounce(1);
                    });
                    monstresLeft.setVelocity(0, 150);

                    //Création des Bordures délimitant les déplacements des Ennemis
                    limitesMonstres = this.physics.add.group();
                    limitesMonstresLayer = carteDuNiveau.getObjectLayer('BordureEnnemi');
                    limitesMonstresLayer.objects.forEach( limitesMonstresLayer => {
                        const LimitesMonstresLayer = limitesMonstres.create( limitesMonstresLayer.x + 16, limitesMonstresLayer.y +16, "BordureEnnemi").body.setAllowGravity(false).setImmovable(true);
                    });                

                    // PLAYER

                        // PLAYER - génération du sprite du personnage aux coordonnées, à partir de la sprite sheet (png avec les animations du perso)
                        player = this.physics.add.sprite(10, 10, 'perso');

                        // PLAYER - Collision entre le joueur et les confins du monde
                        player.setCollideWorldBounds(true);

                        // PLAYER - Collision entre le joueur et les plateformes
                        this.physics.add.collider(player, plateformes, normalPlatsProperties, null, this);

                        this.physics.add.collider(player, plateformesNeige, neigePlatsProperties, null, this);

                        this.physics.add.collider(player, plateformesGlace, glacePlatsProperties, null, this);
                        
                        this.physics.add.collider(player, obstacles, killPlayer, null, this);

                        this.physics.add.overlap(player, esprits, collectEsprits, null, this);

                        // RECOLTE ESPRITS

                    // UI

                        // LIFE
                        lifeUI = this.add.sprite(0,0, 'lifeFull').setOrigin(0,0).setScrollFactor(0);

                        fondScore = this.add.sprite(1108,-6, 'fond_score').setOrigin(0,0).setScrollFactor(0);

                        //affiche un texte à l’écran, pour les collectibles
                        textScore =this.add.text(1150,50,`${espritScore}`,{fontSize:'32px',fill:'#FFFFFF'}).setOrigin(0,0).setScrollFactor(0);

                        //affiche l'image du collectible
                        espritUi =this.add.sprite(1100, 40,'espritUI').setOrigin(0,0).setScrollFactor(0);

                        

                    // ANIMATIONS PLAYER
                    
                        // ANIMATIONS PLAYER - animation marche gauche
                        this.anims.create({
                            key: 'left',
                            frames: this.anims.generateFrameNumbers('perso', {start:0,end:3}),
                            frameRate: 10,
                            repeat: -1
                        });

                        // ANIMATIONS PLAYER - face à la caméra
                        this.anims.create({
                            key: 'turn',
                            frames: [ { key: 'perso', frame: 4 } ],
                            frameRate: 20
                        });

                        // ANIMATIONS PLAYER - Marche droite
                        this.anims.create({
                            key: 'right',
                            frames: this.anims.generateFrameNumbers('perso', {start:5,end:8}),
                            frameRate: 10,
                            repeat: -1
                        });           
                    
                    // COMMANDES

                        // COMMANDES - DEPLACEMENTS HORIZONTAUX
                        cursors = this.input.keyboard.createCursorKeys();

                        // COMMANDES - SAUT (BARRE D'ESPACE)
                        spaceBar = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);

                        keyD = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D);
                        keyQ = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Q);

                        keyWallGrap = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SHIFT);
                                        
                    // CAMERA

                        // CAMERA - limite du champs de la caméra de taille identique à celle du monde
                        this.cameras.main.setBounds(0, 0, 1600, 1600);
                        
                        // CAMERA - taille de la caméra
                        this.cameras.main.setSize(1200, 750);

                        // CAMERA - Zoom de la camera (RETIRE CAR FAIT BUGER L'AFFICHAGE DE L'UI)
                        /*this.cameras.main.setZoom(1, 1)*/

                        // CAMERA - ancrage de la caméra sur le joueur (elle suit le joueur)
                        this.cameras.main.startFollow(player); 

                }

// Déverouillage des commandes
function lockCommandes(){
    commandesLocked = false;
}

// Déverouillage du wall Jump
function lockWallJump(){
    
    if(player.body.onFloor()){
        wallJumpLocked = true;
        
        if(wallIce == false){
        // Coupe l'inertie du saut
        player.setAccelerationX(playerInertie);
        }
    }
    else{
        wallJumpLocked = false;
    }
}

//Gestion du ralentissement sur les ralentisseurs
function normalPlatsProperties() {
    speedMoveX = 150;
    speedMoveY = 210;
    playerInertie = 0;
    wallIce = false;

    console.log("check wallIce + ", wallIce);
}

neigeRalentissement

function neigePlatsProperties() {
    speedMoveX = 100;
    speedMoveY = 210;
    playerInertie = 0;
    wallIce = false;

    console.log("check wallIce + ", wallIce);
}

function glacePlatsProperties() {
    speedMoveX = 150;
    speedMoveY = 210;
    playerInertie = 3000;
    wallIce = true;

    console.log("check wallIce + ", wallIce);
}

// DEPLACEMENT PLAYER

function movementPlayer(){

        // Verification continue que le joueur est au sol ou à l'air pour sauter 
        lockWallJump();

        // DEPLACEMENT PLAYER - GAUCHE
        if ((cursors.left.isDown || keyQ.isDown) && commandesLocked == false){ //si la touche gauche est appuyée
            player.setVelocityX(-speedMoveX); //alors vitesse positive en X
            /*player.setVelocityX(-150); //alors vitesse négative en X*/
            if(player.body.onFloor()){
                player.anims.play('left', true); //et animation => gauche
                player.setAccelerationX(-playerInertie);
            }
        }
        
        // DEPLACEMENT PLAYER - DROITE
        else if ((cursors.right.isDown || keyD.isDown) && commandesLocked == false){ //sinon si la touche droite est appuyée
            player.setVelocityX(speedMoveX); //alors vitesse positive en X

            if(player.body.onFloor()){
                player.anims.play('right', true); //et animation => gauche
                player.setAccelerationX(playerInertie);
            }
        }
        
        // DEPLACEMENT - IDLE
        else { 
            player.setVelocityX(0); //vitesse nulle
            player.anims.play('turn'); //animation fait face caméra
        }
        
        // DEPLACEMENT - SAUT
        if (cursors.up.isDown || spaceBar.isDown){

            // SAUT A TERRE
            if(player.body.onFloor()){
            //si touche haut appuyée ET que le perso touche le sol
            player.setAccelerationY(10);
            player.setMaxVelocity(speedMoveY);
            player.setVelocityY(-speedMoveY); //alors vitesse verticale négative
            //(on saute)
            }
        }

        // SAUT MUR GAUCHE
        if(player.body.blocked.left && keyWallGrap.isDown && wallJumpLocked == false){

            if(wallIce == true){
                player.setVelocityY(20);
                player.setVelocityX(0);
            }
            else if(wallIce == false){
                player.setVelocityY(-5);
                player.setVelocityX(-2);
            }
            
            if (cursors.up.isDown || spaceBar.isDown){
                player.setAccelerationX(4000);
                player.setMaxVelocity(1000);
                player.setVelocityY(-speedMoveY);

                // commandes bloquées
                commandesLocked = true;
                console.log(commandesLocked)
                
                // commandes débloquées
                setTimeout(lockCommandes, 1000);
            }
        }

        // SAUT MUR DROIT
        if(player.body.blocked.right && keyWallGrap.isDown && wallJumpLocked == false){

            if(wallIce == true){
                player.setVelocityY(20);
                player.setVelocityX(0);
            }
            else if(wallIce == false){
                player.setVelocityY(-5);
                player.setVelocityX(2);
            }
            
            if (cursors.up.isDown || spaceBar.isDown){
                player.setAccelerationX(-4000);
                player.setMaxVelocity(1000);
                player.setVelocityY(-speedMoveY);

                // commandes bloquées
                commandesLocked = true;
                console.log(commandesLocked)

                // commandes débloquées
                setTimeout(lockCommandes, 1000);
            }
        }
    }

function killPlayer(){
    gameOver = true;
    console.log("Check death 1");
}

function collectEsprits(player, esprit){
    esprit.destroy(esprit.x, esprit.y);
    espritScore ++; // increment the score
    textScore.setText(`${espritScore}`); // set the text to show the current score
    return false;
}


function respawn(){
    if (gameOver == true){

        lifeUI.setTexture('lifeDead');

        console.log("Check death 2");

        //replace le joueur à la zone de départ
        
        /*setTimeout(player.body.reset(1352, 680), 8000);*/

        setTimeout(function() {player.body.reset(1352, 680);
        gameOver = false;
        lifeUI.setTexture('lifeFull');
        
        }, 8000);


    }
}
                //FONCTION UPDATE - à exécuter à chaque frame du jeu
                function update(){

                    /*this.background.tilePosition.x -= 0.05;*/
                    /*this.secondPlan.tilePosition.x -= 0.3;*/


                    

                    movementPlayer();
                    respawn();

                      

                    /*if (gameOver){return;}*/
                }
        </script>
    </body>
</html>