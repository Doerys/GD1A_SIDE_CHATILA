<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" /><title>Souls Guardian</title>

        <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
        <link href="styles.css" media="all" rel="stylesheet" type="text/css" />

        <style type="text/css"> body { margin: 0; }</style>
    </head>
    <body>
        <script type="text/javascript">
            
            var config = {
                type: Phaser.AUTO,

                // Dimensions du jeu (50 x 50 cases de 32 pixels)
                width: 1200, height: 750,
                
                // Physique du jeu (gravité)
                physics: {
                    default: 'arcade',
                    arcade: {
                    gravity: { y: 600 },
                    debug: true
                    }},

                scene: {preload: preload, create: create, update: update }
                };

                new Phaser.Game(config);

                // FONCTION PRELOAD - précharger en mémoire les éléments de notre jeu (assets)

                function preload(){
                    
                        // NIVEAU - Préchargement de la carte

                            // NIVEAU - chargement tuiles de jeu
                            this.load.image("Phaser_tuilesdejeu", "assets/tuilesJeu.png");

                            // NIVEAU - chargement de la carte
                            this.load.tilemapTiledJSON("carte", "assets/map.json");
                            this.load.image('background', 'assets/background.png');
                            this.load.image('secondPlan', 'assets/secondPlan.png'); 
                            this.load.spritesheet('perso','assets/perso.png',
                                { frameWidth: 32, frameHeight: 48 });
                    }

                // VARIABLES - annonce des variables
                    var platforms;
                    var player;
                    var cursors;
                    var scoreText;
                    var gameOver = false;
                    var bloqueAxeX = false; 

                // FONCTION CREATE - Gère le stade initial du jeu

                function create(){

                    // NIVEAU

                        // NIVEAU - ajout des images de background
                        this.add.image(800, 800, 'background');
                        this.add.image(800, 800, 'secondPlan');

                        // NIVEAU - Intégration de la map de TILED
                            // chargement de la carte
                            const carteDuNiveau = this.add.tilemap("carte");

                            // chargement du jeu de tuiles
                            const tileset = carteDuNiveau.addTilesetImage(
                                    "PremierPlan",
                                    "Phaser_tuilesdejeu",
                                    );

                            // chargement du calque calque_plateformes
                            const plateformes = carteDuNiveau.createLayer(
                                    "plateformes",
                                    tileset
                                    );

                            // chargement du calque pickupobjects
                            const pickupobjects = carteDuNiveau.createLayer(
                                    "pickupobjects",
                                    tileset
                                    );

                            // chargement du calque obstacles
                            const obstacles = carteDuNiveau.createLayer(
                                    "obstacles",
                                    tileset
                                    );
                        
                        // NIVEAU - Plateformes solides
                        plateformes.setCollisionByProperty({ estSolide: true });
                        
                        // NIVEAU - limites du monde avec les dimensions calculées via tiled
                        this.physics.world.setBounds(0, 0, 1600, 1600);

                        // PLAYER

                            // PLAYER - génération du sprite du personnage à partir de la sprite sheet (png avec les animations du perso)
                            player = this.physics.add.sprite(1350, 680, 'perso');
                        
                            // PLAYER - Collision entre le joueur et les confins du monde
                            player.setCollideWorldBounds(true);

                            // PLAYER - Collision entre le joueur et les plateformes
                            this.physics.add.collider(player, plateformes); 
                        
                    // ANIMATIONS PLAYER
                    
                        // ANIMATIONS PLAYER - animation marche gauche
                        this.anims.create({
                            key: 'left',
                            frames: this.anims.generateFrameNumbers('perso', {start:0,end:3}),
                            frameRate: 10,
                            repeat: -1
                        });

                        // ANIMATIONS PLAYER - face à la caméra
                        this.anims.create({
                            key: 'turn',
                            frames: [ { key: 'perso', frame: 4 } ],
                            frameRate: 20
                        });

                        // ANIMATIONS PLAYER - Marche droite
                        this.anims.create({
                            key: 'right',
                            frames: this.anims.generateFrameNumbers('perso', {start:5,end:8}),
                            frameRate: 10,
                            repeat: -1
                        });           
                    
                    // COMMANDES

                        // COMMANDES - DEPLACEMENTS HORIZONTAUX
                        cursors = this.input.keyboard.createCursorKeys();

                        // COMMANDES - SAUT (BARRE D'ESPACE)
                        spaceBar = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
                    
                    // CAMERA

                        // CAMERA - limite du champs de la caméra de taille identique à celle du monde
                        this.cameras.main.setBounds(0, 0, 1600, 1600);
                        
                        // CAMERA - taille de la caméra
                        this.cameras.main.setSize(1200, 750);

                        // CAMERA - Zoom de la camera
                        this.cameras.main.setZoom(2, 2)

                        // CAMERA - ancrage de la caméra sur le joueur (elle suit le joueur)
                        this.cameras.main.startFollow(player); 

                    //affiche un texte à l’écran, pour le score - ! NON FONCTIONNEL !
                    scoreText=this.add.text(16,16,'score: 0',{fontSize:'32px',fill:'#000'});
                }

                //FONCTION UPDATE - à exécuter à chaque frame du jeu
                function update(){

                    // DEPLACEMENT PLAYER
                    
                        // DEPLACEMENT PLAYER - GAUCHE
                        if (cursors.left.isDown && bloqueAxeX == false){ //si la touche gauche est appuyée
                            player.setVelocityX(-150); //alors vitesse négative en X
                            player.anims.play('left', true); //et animation => gauche
                            }
                        
                        // DEPLACEMENT PLAYER - DROITE
                        else if (cursors.right.isDown && bloqueAxeX == false){ //sinon si la touche droite est appuyée
                            player.setVelocityX(150); //alors vitesse positive en X
                            player.anims.play('right', true); //et animation => droite
                            }
                        
                        // DEPLACEMENT - IDLE
                        else { 
                            player.setVelocityX(0); //vitesse nulle
                            player.anims.play('turn'); //animation fait face caméra
                            }
                        
                        // DEPLACEMENT - SAUT
                        if ((cursors.up.isDown || spaceBar.isDown) && player.body.blocked.down){
                            //si touche haut appuyée ET que le perso touche le sol
                            player.setVelocityY(-300); //alors vitesse verticale négative
                            //(on saute)
                            }
                    

                    

                    // MURS

                    // Déverouillage des commandes
                    function lockCommandes(){
                        commandesLocked = false;
                    }

                    // Déverouillage du wall Jump
                    function lockWallJump(){
                        wallJumpLocked = false;
                    }

                    // WALL GRAB PLAYER LEFT (on s'accroche au mur gauche)
                    function wallGrabLeft(){
                        player.setVelocityY(-10); 
                        player.setVelocityX(-15);

                        // WALL JUMP LEFT
                        if (cursors.up.isDown && wallJumpLocked == false){
                            
                            // commandes bloquées
                            commandesLocked = true;

                            // wallJump bloqué
                            wallJumpLocked = true;

                            // personnage repoussé du mur
                            player.setVelocityY(-300);
                            player.setVelocityX(100);

                            // commandes débloquées

                            setTimeout(lockCommandes, 200);
                            
                            // wallJump débloqué

                            setTimeout(lockWallJump, 2000)       
                        }
                    }

                    // WALL GRAB PLAYER LEFT (on s'accroche au mur droit)
                    function wallGrabRight(){
                        player.setVelocityY(-10); 
                        player.setVelocityX(15);

                        // WALL JUMP LEFT
                        if (cursors.up.isDown && wallJumpLocked == false){
                            
                            // commandes bloquées
                            commandesLocked = true;

                            // wallJump bloqué
                            wallJumpLocked = true;

                            // personnage repoussé du mur
                            player.setVelocityY(-300);
                            player.setVelocityX(-100);

                            // commandes débloquées

                            setTimeout(lockCommandes, 200);
                            
                            // wallJump débloqué

                            setTimeout(lockWallJump, 2000)       
                        }
                    }




                        

                    if (gameOver){return;}
                }
        </script>
    </body>
</html>
