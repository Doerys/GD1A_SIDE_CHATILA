<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" /><title>Souls Guardian</title>

        <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>

        <style type="text/css"> body { margin: 0; }</style>>
    </head>
    <body>
        <script type="text/javascript">
            
            var config = {
                type: Phaser.AUTO,

                // Dimensions de l'espace de la fenêtre alloué au jeu
                width: 1200, height: 750,
                
                // Physique du jeu (gravité)
                physics: {
                    default: 'arcade',
                    arcade: {
                    gravity: { y: 300 },
                    debug: true
                    }},

                input:{gamepad:true},
                scene: {preload: preload, create: create, update: update }
                };

                new Phaser.Game(config);

// VARIABLES
let platforms;
let player;

let cursors;

let jumpMax = 1;
let jumpLeft = jumpMax;
let coolDownJump = false;
let commandesLocked = false;
let wallJumpLocked = false;

// FONCTION PRELOAD - précharger en mémoire les éléments de notre jeu (assets)
function preload(){

    // Player
    this.load.spritesheet('perso','assets/perso.png',
        { frameWidth: 32, frameHeight: 48 });

    // PLATEFORMES
        this.load.tilemapTiledJSON("carte", "assets/map.json");
        this.load.image("Phaser_tuilesdejeu", "assets/tuilesJeu.png");

    // ----------------------------------------------------- FIN FONCTION PRELOAD ----------------------------------------------

}

// FONCTION CREATE - Gère le stade initial du jeu
function create(){

    // PLAYER
        player = this.physics.add.sprite(10, 10, 'perso');

    // MAP DE TILED
        // TILEMAP    
            const carteDuNiveau = this.add.tilemap("carte");

        // TILESET
            const tileset = carteDuNiveau.addTilesetImage("tuiles_de_jeu","Phaser_tuilesdejeu",);

            // PLATEFORMES NORMALES []
                const plateformes = carteDuNiveau.createLayer("plateformes",tileset);

                // collisions
                plateformes.setCollisionByProperty({estSolide: true });
                this.physics.add.collider(player, plateformes);

    // LIMITES DU NIVEAU

        // LIMITES DU NIVEAU VIA DIMENSIONS
        this.physics.world.setBounds(0, 0, 1600, 1600);

        // PLAYER - Collision entre le joueur et les limites du niveau
        player.setCollideWorldBounds(true);

    // COMMANDES

        // CLAVIER
            // DEPLACEMENTS FLECHES DIRECTIONNELLES
            cursors = this.input.keyboard.createCursorKeys();

    // CAMERA

        // LIMITES CAMERA (champs de la caméra de taille identique à celle du niveau)
        this.cameras.main.setBounds(0, 0, 1600, 1600);
        
        // TAILLE
        this.cameras.main.setSize(1200, 750);

        // ANCRAGE CAMERA - JOUEUR
        this.cameras.main.startFollow(player);        

    // ----------------------------------------------------- FIN FONCTION CREATE ----------------------------------------------
}

//FONCTION UPDATE - s'exécute à chaque frame du jeu
function update(){

    if(player.body.onFloor()){ // si le joueur est au sol
        jumpLeft = jumpMax;
        console.log("DETECT ON FLOOR");
    }

    // DEPLACEMENT - GAUCHE
    if (cursors.left.isDown){ //si la touche gauche est appuyée
        player.setVelocityX(-150); //alors vitesse négative en X
        
    }

    // DEPLACEMENT - DROITE
    else if (cursors.right.isDown){ //sinon si la touche droite est appuyée
        player.setVelocityX(150); //alors vitesse positive en X

    }

    // IDLE
    else { 
        player.setVelocityX(0); //vitesse nulle
    }

    // DEPLACEMENT - SAUT
    if (cursors.up.isDown && jumpLeft > 0 && coolDownJump == false){

        // SAUT A TERRE
        //if(player.body.onFloor()){
            
            jumpLeft -= 1;
            coolDownJump = true;
            console.log('JumpLeft = ', jumpLeft);

            setTimeout(function() {
                coolDownJump = false;
                console.log("REJUMP ! + ", jumpLeft);            
            }, 500);

            player.setVelocityY(-150); //alors vitesse verticale négative
            //(on saute)
        //}
    }
}

// --------------------------------- FONCTIONS ---------------------------------

// Déverouillage des commandes
function unlockCommandes(){
    commandesLocked = false;
}
        </script>
    </body>
</html>